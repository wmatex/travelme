<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>TravelMe</title>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.blue-indigo.min.css">
  <script src="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>

/*!
 * Bootstrap v3.0.0
 *
 * Copyright 2013 Twitter, Inc
 * Licensed under the Apache License v2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Designed and built with all the love in the world @twitter by @mdo and @fat.
 */

  .logo {
    background-size: cover;
    height: 58px;
    width: 180px;
    margin-top: 6px;
  }
.logo a {
  display: block;
  width: 100%;
  height: 100%;
}
*, *:before, *:after {
    -moz-box-sizing: border-box;
    box-sizing: border-box;
}
aside,
footer,
header,
hgroup,
section{
  display: block;
}
body {
  color: #404040;
  font-family: "Helvetica Neue",Helvetica,"Liberation Sans",Arial,sans-serif;
  font-size: 14px;
  line-height: 1.4;
}

html {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
}
ul {
    margin-top: 0;
}
.container {
  margin-right: auto;
  margin-left: auto;
  padding-left: 15px;
  padding-right: 15px;
}
.container:before,
.container:after {
  content: " ";
  /* 1 */

  display: table;
  /* 2 */

}
.container:after {
  clear: both;
}
.row {
  margin-left: -15px;
  margin-right: -15px;
}
.row:before,
.row:after {
  content: " ";
  /* 1 */

  display: table;
  /* 2 */

}
.row:after {
  clear: both;
}
.col-sm-6, .col-md-6, .col-xs-12 {
  position: relative;
  min-height: 1px;
  padding-left: 15px;
  padding-right: 15px;
}
.col-xs-12 {
  width: 100%;
}

@media (min-width: 768px) {
  .container {
    width: 750px;
  }
  .col-sm-6 {
    float: left;
  }
  .col-sm-6 {
    width: 50%;
  }
}

@media (min-width: 992px) {
  .container {
    width: 970px;
  }
  .col-md-6 {
    float: left;
  }
  .col-md-6 {
    width: 50%;
  }
}
@media (min-width: 1200px) {
  .container {
    width: 1170px;
  }
}

a {
  color: #069;
  text-decoration: none;
}
a:hover {
  color: #EA0011;
  text-decoration: underline;
}
hgroup {
  margin-top: 50px;
}
footer {
    margin: 50px 0 25px;
}
h1, h2, h3 {
  color: #000;
  line-height: 1.38em;
  margin: 1.5em 0 .3em;
}
h1 {
  font-size: 25px;
  font-weight: 300;
  border-bottom: 1px solid #fff;
  margin-bottom: .5em;
}
h1:after {
  content: "";
  display: block;
  width: 100%;
  height: 1px;
  background-color: #ddd;
}
h2 {
  font-size: 19px;
  font-weight: 400;
}
h3 {
  font-size: 15px;
  font-weight: 400;
  margin: 0 0 .3em;
}
p {
  margin: 0 0 2em;
}
p + h2 {
  margin-top: 2em;
}
html {
  background: #f5f5f5;
  height: 100%;
}
code {
  background-color: white;
  border: 1px solid #ccc;
  padding: 1px 5px;
  color: #888;
}
pre {
  display: block;
  padding: 13.333px 20px;
  margin: 0 0 20px;
  font-size: 13px;
line-height: 1.4;
  background-color: #fff;
  border-left: 2px solid rgba(120,120,120,0.35);
  white-space: pre;
  white-space: pre-wrap;
  word-break: normal;
  word-wrap: break-word;
  overflow: auto;
  font-family: Menlo,Monaco,"Liberation Mono",Consolas,monospace !important;
}

#map {
  height: 500px;
}

.demo-card-image.mdl-card {
  width: 256px;
  height: 256px;
}
.demo-card-image > .mdl-card__actions {
  height: 52px;
  padding: 16px;
  background: rgba(0, 0, 0, 0.2);
}
.demo-card-image__filename {
  color: #fff;
  font-size: 14px;
  font-weight: 500;
}

</style>

</head>
<body>
<section class='container'>
          <hgroup>
            <h1>Welcome to your Node.js application on OpenShift</h1>
          </hgroup>


        <div class="row">
          <section class='col-xs-12 col-sm-12 col-md-12'>
            <div id="map"></div>
          </section>
        </div>

        <footer>
          <div class="logo"><a href="https://www.openshift.com/"></a></div>
        </footer>
</section>
<script type="text/javascript">
var map;
function initMap() {
  $(function() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 50.075328, lng: 14.420450},
      zoom: 8
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        map.setCenter({
          lat: position.coords.latitude,
          lng: position.coords.longitude
        });
        map.setZoom(15);
      });
    }
    var origin, destination;
    var _points = {
      origin: null,
      destination: null,
    }
    var markers = {
      origin: null,
      dest: null
    };

    var _directions = null;

    var _places = [];

    var directionsDisplay = new google.maps.DirectionsRenderer();
    directionsDisplay.setMap(map);

    function displayDirectionsPolyline(directions) {
      var points = google.maps.geometry.encoding.decodePath(directions.routes[0].overview_polyline.points);
      if (_directions != null) {
        _directions.setMap(null);
        _directions = null;
      }
      _directions = new google.maps.Polyline({
        path: points,
        strokeColor: '#FF0000',
        strokeWeight: 3,
        map: map,
      });
    }

    function searchVenues() {
      console.log("searching");
      $.getJSON("/route/"+_points.origin.lat() + "," + _points.origin.lng() + "/" + _points.destination.lat() + "," + _points.destination.lng(),
      function(data) {
        console.log(data);
        displayDirectionsPolyline(data.directions);

        $.each(data.places, function(key, item) {
          if (item != null) {
            $.each(item, function(key, place) {
              if (typeof place.venue != "undefined") {
                var photo = place.venue.featuredPhotos.items[0];
                var place = {
                  m: new google.maps.Marker({
                    position: {lat: place.venue.location.lat, lng: place.venue.location.lng },
                    map: map,
                  }),
                  w: new google.maps.InfoWindow({
                    content: '<div class="demo-card-image mdl-card mdl-shadow--2dp" style="background: url(\'' + photo.prefix + "cap256" + photo.suffix + '\') center / cover"><div class="mdl-card__title mdl-card--expand"></div> <div class="mdl-card__actions"> <span class="demo-card-image__filename">' + place.venue.name + '</span> </div></div>'

                  })
                };
                place.m.addListener('click', function() {
                  place.w.open(map, place.m);
                });
                _places.push(place);
              }
            });
          }
        });
      });
    }

    function createMarker(latLng, point) {
      var marker = new google.maps.Marker({
        position: latLng,
        animation: google.maps.Animation.DROP,
        map: map,
        draggable: true,
      });
      marker.addListener('dragend', function(e) {
        console.log(e);
        _points[point] = e.latLng;
        searchVenues();
      });
    }

    map.addListener('click', function(e) {
      if (_points.origin == null || (_points.origin != null && _points.destination != null)) {
        if (_points.origin != null) {
          _points.origin = null;
          _points.destination = null;
          markers.origin.setMap(null);
          markers.dest.setMap(null);
          markers.origin = null;
          markers.dest = null;
        }
        markers.origin = createMarker(e.latLng, "origin");
        _points.origin = e.latLng;
      } else if (destination == null) {
        markers.dest = createMarker(e.latLng, "destination");
        _points.destination = e.latLng;

        searchVenues();
      }
    });
  });
}

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap">
</script>
</body>
</html>
