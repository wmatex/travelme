<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>TravelMe</title>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.blue-indigo.min.css">
  <script src="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
#map {
  height: 700px;
}

.demo-card-image.mdl-card {
  width: 256px;
  height: 256px;
}
.demo-card-image > .mdl-card__actions {
  height: 52px;
  padding: 16px;
  background: rgba(0, 0, 0, 0.2);
}
.demo-card-image__filename {
  color: #fff;
  font-size: 14px;
  font-weight: 500;
}

#loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.2);
  z-index: 1000;
}

#loading > .mdl-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  margin-left: -14px;
  margin-top: -14px;
}

.options {
  padding: 20px;
  text-align: center;
}

.options label.mdl-radio {
  margin-right: 20px;
}

</style>

</head>
<body>
<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
  <header class="mdl-layout__header">
    <div class="mdl-layout__header-row">
      <!-- Title -->
      <span class="mdl-layout-title">TravelMe</span>
      <!-- Add spacer, to align navigation to the right -->
      <div class="mdl-layout-spacer"></div>
      <!-- Navigation. We hide it in small screens. -->
    </div>
  </header>
  <main class="mdl-layout__content">
    <div class="page-content">
      <div class="options">
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-1">
          <input type="radio" id="option-1" class="mdl-radio__button" name="options" value="all" checked>
          <span class="mdl-radio__label">All</span>
        </label>
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-2">
          <input type="radio" id="option-2" class="mdl-radio__button" name="options" value="food">
          <span class="mdl-radio__label">Food</span>
        </label>
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-3">
          <input type="radio" id="option-3" class="mdl-radio__button" name="options" value="drinks">
          <span class="mdl-radio__label">Drinks</span>
        </label>
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-4">
          <input type="radio" id="option-4" class="mdl-radio__button" name="options" value="coffee">
          <span class="mdl-radio__label">Coffee</span>
        </label>
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-5">
          <input type="radio" id="option-5" class="mdl-radio__button" name="options" value="shops">
          <span class="mdl-radio__label">Shops</span>
        </label>
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-6">
          <input type="radio" id="option-6" class="mdl-radio__button" name="options" value="arts">
          <span class="mdl-radio__label">Arts</span>
        </label>
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-7">
          <input type="radio" id="option-7" class="mdl-radio__button" name="options" value="outdoors">
          <span class="mdl-radio__label">Outdoors</span>
        </label>
        <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-8">
          <input type="radio" id="option-8" class="mdl-radio__button" name="options" value="sights">
          <span class="mdl-radio__label">Sights</span>
        </label>
      </div>
      <div id="map"></div>
    </div>
  </main>
  <div id="loading">
    <div class="mdl-spinner mdl-js-spinner is-active"></div>
  </div>
</div>
<script type="text/javascript">
var map;
function initMap() {
  $(function() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 50.075328, lng: 14.420450},
      zoom: 8
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        map.setCenter({
          lat: position.coords.latitude,
          lng: position.coords.longitude
        });
        map.setZoom(15);
      });
    }
    var origin, destination;
    var _points = {
      origin: null,
      destination: null,
    }
    var markers = {
      origin: null,
      dest: null
    };

    var _directions = null;

    var _places = [];

    var directionsDisplay = new google.maps.DirectionsRenderer();
    directionsDisplay.setMap(map);

    function displayDirectionsPolyline(directions) {
      var points = google.maps.geometry.encoding.decodePath(directions.routes[0].overview_polyline.points);
      _directions = new google.maps.Polyline({
        path: points,
        strokeColor: '#00B3FD',
        strokeWeight: 4,
        map: map,
      });
    }

    function clearPlaces() {
      if (_directions != null) {
        _directions.setMap(null);
        _directions = null;
      }
      $.each(_places, function (key, place) {
        place.m.setMap(null);
      });
      _places = [];
    }

    function searchVenues() {
      console.log("searching");
      $("#loading").show();
      var section = $('.options input[name=options]:checked').val();
      console.log(section);
      var query = {};
      if (section != 'all') {
        query.section = section;
      }
      clearPlaces();
      $.getJSON("/route/"+_points.origin.lat() + "," + _points.origin.lng() + "/" + _points.destination.lat() + "," + _points.destination.lng(), query,
      function(data) {
        console.log(data);
        displayDirectionsPolyline(data.directions);

        $.each(data.places, function(key, item) {
          if (item != null) {
            $.each(item, function(key, place) {
              if (typeof place.venue != "undefined") {
                var photo = null;
                if (place.venue.photos.groups.length > 0 && place.venue.photos.groups[0].items.length > 0) {
                  var p = place.venue.photos.groups[0].items[0];
                  photo = p.prefix + "cap256" + p.suffix;
                }
                var category = place.venue.categories[0].icon;
                var place = {
                  m: new google.maps.Marker({
                    position: {lat: place.venue.location.lat, lng: place.venue.location.lng },
                    map: map,
                    icon: category.prefix + "bg_32" + category.suffix,
                  }),
                  w: new google.maps.InfoWindow({
                    content: '<div class="demo-card-image mdl-card mdl-shadow--2dp" style="background: url(\'' + photo + '\') center / cover"><div class="mdl-card__title mdl-card--expand"></div> <div class="mdl-card__actions"> <span class="demo-card-image__filename">' + place.venue.name + '</span> </div></div>'

                  })
                };
                place.m.addListener('click', function() {
                  place.w.open(map, place.m);
                });
                _places.push(place);
              }
            });
          }
        });
        $("#loading").hide();
      });
    }

    function createMarker(latLng, point, label) {
      var marker = new google.maps.Marker({
        position: latLng,
        animation: google.maps.Animation.DROP,
        map: map,
        label: label,
        draggable: true,
      });
      marker.addListener('dragend', function(e) {
        console.log(e);
        _points[point] = e.latLng;
        searchVenues();
      });
      return marker;
    }

    map.addListener('click', function(e) {
      if (_points.origin == null || (_points.origin != null && _points.destination != null)) {
        if (_points.origin != null) {
          _points.origin = null;
          _points.destination = null;
          markers.origin.setMap(null);
          markers.dest.setMap(null);
          markers.origin = null;
          markers.dest = null;
        }
        clearPlaces();
        markers.origin = createMarker(e.latLng, "origin", "S");
        _points.origin = e.latLng;
      } else if (destination == null) {
        markers.dest = createMarker(e.latLng, "destination", "G");
        _points.destination = e.latLng;

        searchVenues();
      }
    });
  });
}

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap">
</script>
</body>
</html>
